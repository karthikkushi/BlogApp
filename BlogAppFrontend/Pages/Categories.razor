@page "/categories"
@using BlogAppFrontend.Models
@using BlogAppFrontend.Services
@inject BlogService BlogService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<PageTitle>Categories - BlogApp</PageTitle>

<style>
    .gradient-header {
        background: linear-gradient(90deg, #2563EB, #1D4ED8);
        padding: 24px;
        border-radius: 16px 16px 0 0;
        color: #fff;
    }

    .section-card {
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        margin-bottom: 24px;
    }

    .clickable-category {
        color: #2563EB;
        cursor: pointer;
        font-weight: 500;
        transition: color 0.2s;
    }

        .clickable-category:hover {
            color: #1D4ED8;
            text-decoration: underline;
        }
</style>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-6">

    <!-- Gradient header -->
    <MudPaper Class="gradient-header section-card">
        <MudText Typo="Typo.h4">Categories</MudText>
        <MudText Typo="Typo.subtitle2" Class="mt-1">
            Manage your blog categories to organize posts effectively.
        </MudText>
    </MudPaper>

    <!-- Add New Category -->
    <MudPaper Class="pa-4 section-card">
        <MudText Typo="Typo.h6" Class="mb-3">Add New Category</MudText>
        <MudForm @ref="_form">
            <MudStack Spacing="2">
                <MudTextField @bind-Value="_newCategory.Name" Label="Name" Variant="Variant.Outlined" Required="true" For="@(() => _newCategory.Name)" />
                <MudTextField @bind-Value="_newCategory.Description" Label="Description" Variant="Variant.Outlined" Lines="2" />
                <MudButton OnClick="AddCategory" Variant="Variant.Filled" Color="Color.Primary" Class="mt-2">
                    Add Category
                </MudButton>
            </MudStack>
        </MudForm>
    </MudPaper>

    @if (showEditForm)
    {
        <!-- Edit Category -->
        <MudPaper Class="pa-4 section-card">
            <MudText Typo="Typo.h6" Class="mb-3">Edit Category</MudText>
            <MudForm @ref="_editForm">
                <MudStack Spacing="2">
                    <MudTextField @bind-Value="_editCategory.Name" Label="Name" Variant="Variant.Outlined" Required="true" For="@(() => _editCategory.Name)" />
                    <MudTextField @bind-Value="_editCategory.Description" Label="Description" Variant="Variant.Outlined" Lines="2" />
                    <MudStack Row="true" Spacing="2" Class="mt-2">
                        <MudButton OnClick="UpdateCategory" Variant="Variant.Filled" Color="Color.Primary">
                            Update
                        </MudButton>
                        <MudButton OnClick="CancelEdit" Variant="Variant.Outlined" Color="Color.Secondary">
                            Cancel
                        </MudButton>
                    </MudStack>
                </MudStack>
            </MudForm>
        </MudPaper>
    }

    <!-- Categories Table -->
    <MudPaper Class="pa-4 section-card">
        <MudText Typo="Typo.h6" Class="mb-3">All Categories</MudText>

        <MudTable Items="_categories" Hover="true" Bordered="true" Striped="true" Dense="true">
            <HeaderContent>
                <MudTh>Name</MudTh>
                <MudTh>Description</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Name">
                    <MudText Class="clickable-category"
                             @onclick="() => ViewPostsByCategory(context.Id, context.Name)">
                        @context.Name
                    </MudText>
                </MudTd>
                <MudTd DataLabel="Description">@context.Description</MudTd>
                <MudTd DataLabel="Actions">
                    <MudStack Row="true" Spacing="1">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                       Color="Color.Primary"
                                       Size="Size.Small"
                                       OnClick="@(() => EditCategory(context))" />

                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                       Color="Color.Error"
                                       Size="Size.Small"
                                       OnClick="@(() => DeleteCategory(context.Id))" />
                    </MudStack>
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText Typo="Typo.body2" Color="Color.Secondary">No categories found.</MudText>
            </NoRecordsContent>
        </MudTable>
    </MudPaper>

</MudContainer>

@code {
    private List<Category> _categories = new();
    private Category _newCategory = new();
    private Category _editCategory = new();
    private MudForm _form;
    private MudForm _editForm;
    private bool showEditForm = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadCategoriesAsync();
    }

    private async Task LoadCategoriesAsync()
    {
        _categories = await BlogService.GetCategoriesAsync();
    }

    private void ViewPostsByCategory(string categoryId, string categoryName)
    {
        Navigation.NavigateTo($"/posts?category={categoryId}");
    }

    private async Task AddCategory()
    {
        await _form.Validate();
        if (!_form.IsValid) return;

        if (string.IsNullOrEmpty(_newCategory.Name?.Trim()))
        {
            Snackbar.Add("Category name is required.", Severity.Error);
            return;
        }

        try
        {
            _newCategory.Name = _newCategory.Name.Trim();
            _newCategory.Description = _newCategory.Description?.Trim() ?? string.Empty;

            await BlogService.CreateCategoryAsync(_newCategory);
            Snackbar.Add("Category added successfully.", Severity.Success);
            _newCategory = new Category();
            await LoadCategoriesAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to add category: {ex.Message}", Severity.Error);
        }
    }

    private void EditCategory(Category category)
    {
        _editCategory = new Category
            {
                Id = category.Id,
                Name = category.Name,
                Description = category.Description
            };
        showEditForm = true;
    }

    private async Task UpdateCategory()
    {
        await _editForm.Validate();
        if (!_editForm.IsValid) return;

        if (string.IsNullOrEmpty(_editCategory.Name?.Trim()))
        {
            Snackbar.Add("Category name is required.", Severity.Error);
            return;
        }

        try
        {
            _editCategory.Name = _editCategory.Name.Trim();
            _editCategory.Description = _editCategory.Description?.Trim() ?? string.Empty;

            await BlogService.UpdateCategoryAsync(_editCategory.Id, _editCategory);
            Snackbar.Add("Category updated successfully.", Severity.Success);
            showEditForm = false;
            await LoadCategoriesAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to update category: {ex.Message}", Severity.Error);
        }
    }

    private void CancelEdit()
    {
        showEditForm = false;
        _editCategory = new Category();
    }

    private async Task DeleteCategory(string id)
    {
        bool? confirmed = await DialogService.ShowMessageBox(
            "Confirm Delete",
            "Are you sure you want to delete this category?",
            yesText: "Delete", cancelText: "Cancel");

        if (confirmed != true) return;

        try
        {
            await BlogService.DeleteCategoryAsync(id);
            Snackbar.Add("Category deleted successfully.", Severity.Success);
            await LoadCategoriesAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to delete category: {ex.Message}", Severity.Error);
        }
    }

    [Inject] public IDialogService DialogService { get; set; }
}
